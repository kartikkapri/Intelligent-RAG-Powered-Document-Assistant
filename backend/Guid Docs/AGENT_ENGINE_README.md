# Agent Engine - Task Execution System

## Overview

The Agent Engine is a powerful task execution system that allows users to provide natural language instructions for multiple tasks, which are then executed sequentially. The agent can:

- **Write and send emails** (AI generates the content)
- **Create files and write essays** (AI generates the content)
- **Open URLs and YouTube links** in the browser
- **Integrate with MCP servers** (Notion, GitHub, Slack, etc.)
- **Execute multiple tasks sequentially** using "then", "and then", "after that"

## Architecture

### Components

1. **TaskParser** (`task_parser.py`)
   - Parses natural language input to extract structured tasks
   - Recognizes task types: email, file, browser, mcp, general
   - Extracts parameters like recipients, file paths, URLs, etc.

2. **TaskExecutor** (`task_executor.py`)
   - Executes individual tasks
   - Handles email sending, file operations, browser actions
   - Logs execution results

3. **MCPClient** (`mcp_client.py`)
   - Framework for integrating with MCP (Model Context Protocol) servers
   - Supports Notion, GitHub, Slack
   - Extensible for additional MCP servers

4. **TaskOrchestrator** (`task_orchestrator.py`)
   - Coordinates task parsing, AI generation, and execution
   - Uses Ollama for AI content generation
   - Executes tasks sequentially

5. **AgentEngine** (`agent_engine.py`)
   - Main interface for the agent system
   - Detects task requests vs regular chat
   - Returns structured responses with browser actions

## Usage Examples

### Example 1: Email Task
```
User: "Write an email to john@example.com about the project update and send it"
```

The agent will:
1. Generate email content about "project update"
2. Send email to john@example.com

### Example 2: Multiple Tasks
```
User: "First write an email to alice@example.com about the meeting, then create a text file called notes.txt and write an essay about AI, then open youtube.com"
```

The agent will:
1. Generate and send email to alice@example.com
2. Create notes.txt with an AI-generated essay
3. Open youtube.com in the browser

### Example 3: File Creation
```
User: "Create a file called report.txt and write an essay about climate change"
```

The agent will:
1. Generate an essay about climate change
2. Save it to report.txt

### Example 4: Browser Actions
```
User: "Open https://github.com and then visit youtube.com/watch?v=dQw4w9WgXcQ"
```

The agent will:
1. Open GitHub in a new browser tab
2. Open the YouTube video in a new browser tab

## Configuration

### Email Configuration

Set environment variables for email sending:
```bash
export SMTP_HOST=smtp.gmail.com
export SMTP_PORT=587
export SMTP_USERNAME=your-email@gmail.com
export SMTP_PASSWORD=your-app-password
```

### MCP Server Configuration

#### Notion
```bash
export NOTION_API_KEY=your-notion-api-key
```

#### GitHub
```bash
export GITHUB_TOKEN=your-github-token
```

#### Slack
```bash
export SLACK_WEBHOOK_URL=your-slack-webhook-url
```

## API Endpoints

### POST `/chat`

Standard chat endpoint that supports task execution in agent mode.

**Request:**
```json
{
  "message": "Write an email to user@example.com about the project",
  "mode": "agent",
  "system_prompt": "You are a helpful AI assistant.",
  "history": [],
  "user_id": "default_user"
}
```

**Response:**
```json
{
  "response": "ðŸ¤– **Task Execution Results**\n...",
  "mode": "agent",
  "tokens_used": 150,
  "chat_id": "chat_123",
  "browser_actions": [
    {
      "url": "https://example.com",
      "action": "open"
    }
  ],
  "task_results": {
    "success": true,
    "tasks_parsed": 1,
    "execution_results": [...]
  }
}
```

### POST `/chat/stream`

Streaming endpoint that also supports task execution. Browser actions are included in the final `done` message.

## Task Types

### Email Tasks
- **Patterns**: "write email to X", "send email to X about Y"
- **Parameters**: recipient, subject, body context
- **AI Generation**: Email body is generated by AI based on context

### File Tasks
- **Patterns**: "create file X", "write essay in file Y", "save to file Z"
- **Parameters**: file_path, content_type (essay/text), topic
- **AI Generation**: Content is generated by AI based on topic

### Browser Tasks
- **Patterns**: "open X", "visit Y", "go to Z", "youtube"
- **Parameters**: url
- **Action**: Opens URL in new browser tab (frontend handles this)

### MCP Tasks
- **Patterns**: "use notion to X", "connect to github for Y"
- **Parameters**: mcp_server, action, params
- **Integration**: Connects to configured MCP servers

## Frontend Integration

The frontend automatically handles browser actions. When the agent returns `browser_actions`, the frontend opens each URL in a new tab:

```javascript
if (data.browser_actions && Array.isArray(data.browser_actions)) {
  data.browser_actions.forEach(action => {
    if (action.url) {
      window.open(action.url, '_blank', 'noopener,noreferrer');
    }
  });
}
```

## File Output Location

Files created by the agent are saved to the `agent_outputs/` directory by default. You can change this in `TaskExecutor.__init__()`.

## Error Handling

The agent handles errors gracefully:
- If email credentials are not configured, it generates the email but reports that sending failed
- If file creation fails, it reports the error
- Browser actions are always successful (frontend handles opening)
- MCP server errors are reported if servers are not configured

## Extending the System

### Adding New Task Types

1. Add patterns to `TaskParser.task_patterns`
2. Add executor method to `TaskExecutor`
3. Add handler to `TaskOrchestrator._execute_single_task`

### Adding New MCP Servers

1. Add server config to `MCPClient._initialize_servers`
2. Add action handler method (e.g., `execute_custom_server_action`)
3. Update `execute_mcp_action` to route to new handler

## Notes

- The agent uses Ollama for AI content generation (email bodies, essays, etc.)
- Task execution is sequential - tasks are executed one after another
- Browser actions are handled asynchronously by the frontend
- All task executions are logged in `TaskExecutor.execution_log`



